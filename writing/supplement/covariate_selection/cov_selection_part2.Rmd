---
title: "Covariate Selection"
subtitle: Supplementary material
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: no
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    fig_caption: yes
    code_folding: hide
    number_sections: no
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
---

```{r, include = F}
knitr::opts_chunk$set(message = F)
```

# Data pre-processing

```{r, include = F}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

## Packages & Options

```{r}
library(tidyverse)
library(brms)
library(projpred)
library(bayesplot)

# retrieve # of cores
ncores <- parallel::detectCores()

# for output clarity
options(scipen = 999)
```

## Data

```{r}
apes1 <- read_csv("../../../data/laac_data_trial.csv")
# apes2 <- read_csv("../../../data/laac_data_task.csv")
```

```{r}
# remove variables not relevant to PPI analysis
apes1 <- apes1 %>% 
  select(-c(time_waited, birth_date, comment, experimenter, pick, condition, heat))
```

```{r}
fn0 <- function(x, ...) {
  # helper function
  # sum over `correct response` variable (code)
  to_return = tibble(cogn = sum(x$code))
  return(to_return)
}

code_sum <- apes1 %>%
  # contains summed code variable for [task, time point, session, subject]
  group_by(time_point, session, subject, task) %>%
  group_modify(fn0)

apes1_tmp <- apes1 %>%
  # helper for merging
  select(-c(date, trial_session, trial_time_point, code)) %>%
  unique(by = c("time_point", "session", "subject"))

apes1_new <- 
  as_tibble(merge(apes1_tmp, code_sum, by = c("time_point", "session", "subject", "task"))) %>%
  mutate(across(c(subject, group, test_day, le_present, dist_present, sex, rearing, observer), as_factor)) %>%
  mutate(observer = fct_relevel(observer, "no")) %>% 
  jtools::center(.,vars = c("sick_severity",
                            "le_mean",
                            "time_outdoors",
                            "age",
                            "time_in_leipzig")) %>%
  group_by(group, time_point) %>%
  mutate(rank_gmc = rank - mean(rank, na.rm = TRUE)) %>%
  mutate(rearing = fct_recode(rearing, "hand" = "unknown")) %>%  # recode rearing categories: hand -> unknown
  ungroup() %>%
  arrange(time_point)

grp_size <- tibble(
  # number of apes for each species
  a_chimp = 20,
  b_chimp = 6,
  bonobo = 12,
  gorilla = 6,
  orangutan = 6
)

apes1_new <- apes1_new %>%
  # create rank variable depending on species
  group_by(group, time_point) %>%
  mutate(
    rel_rank = case_when(
      group == "a_chimp" ~ percent_rank(grp_size$a_chimp:1)[rank],
      group == "b_chimp" ~ percent_rank(grp_size$b_chimp:1)[rank],
      group == "bonobo" ~ percent_rank(grp_size$bonobo:1)[rank],
      group == "gorilla" ~ percent_rank(grp_size$gorilla:1)[rank],
      group == "orangutan" ~ percent_rank(grp_size$orangutan:1)[rank]
    )
  ) %>%
  ungroup()
  
apes1_new <-  apes1_new %>% 
  mutate(observer_mod = case_when(
    observer == "yes" ~ "yes",
    observer == "no" ~ "no",
    observer != "no" & observer != "yes" & observer != "NA" ~ "yes",
    TRUE ~ "no"
  ), observer_mod =  as_factor(observer_mod))

t_cau <- filter(apes1_new, task == "causality")
t_inf <- filter(apes1_new, task == "inference")
t_quant <- filter(apes1_new, task == "quantity")
t_gaze <- filter(apes1_new, task == "gaze_following")
t_grat <- filter(apes1_new, task == "delay_of_gratification")

t_gaze <- t_gaze %>%
  # create dummy variable indicating if session 1 or 2
  group_by(time_point, session) %>% 
  mutate(tp_mod = cur_group_id()) %>%
  ungroup() %>% 
  mutate(day2 = case_when(session == 1 ~ "no",
                          session == 2 ~ "yes"),
         day2 = factor(day2)) %>%
  select(tp_mod, day2, everything())

t_gaze <- t_gaze %>%
  # remove duplicates created by day2
  group_by(subject) %>%
  filter(!duplicated(tp_mod)) %>%   
  ungroup() 
```

```{r}
# filter data to only include time points from phase 1
t_cau_p1 <- filter(t_cau, time_point < 15)
t_inf_p1 <- filter(t_inf, time_point < 15)
t_quant_p1 <- filter(t_quant, time_point < 15)
t_gaze_p1 <- filter(t_gaze, time_point < 15)

# filter data to only include time points from phase 2
t_cau_p2 <- filter(t_cau, time_point >= 15)
t_inf_p2 <- filter(t_inf, time_point >= 15)
t_quant_p2 <- filter(t_quant, time_point >= 15)
t_gaze_p2 <- filter(t_gaze, time_point >= 15)
t_grat_p2 <- filter(t_grat, time_point >= 15)
```

# Covariate selection

```{r}
# formula for reference model
fm <- formula(cogn ~ sick_severity +                    
                test_day + test_tp +                
                rel_rank + # rank_gmc +
                observer_mod + 
                age + time_in_leipzig +
                sex + group +
                rearing +
                le_mean + # le_max + # le_present +         
                dist_mean + # dist_max + # + dist_present +
                time_outdoors +
                sociality + # sociality_total +
                # heat_mod + # heat +
                (1|subject)                         
              )

fm_gaze <- update(fm, . ~ . +day2 -test_day)
```

## Reference Model: 2-level Multilevel Model (random intercepts only)

```{r, warning = F}
m_cau_2l_p1 <- brm(fm, data = t_cau_p1, 
                   warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                   seed = 2021,
                   save_pars = save_pars(all = TRUE)
                   )
m_inf_2l_p1 <- brm(fm, data = t_inf_p1, 
                   warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                   seed = 2021,
                   save_pars = save_pars(all = TRUE)
                   )
m_quant_2l_p1 <- brm(fm, data = t_quant_p1, 
                     warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                     seed = 2021,
                     save_pars = save_pars(all = TRUE)
                     )
m_gaze_2l_p1 <- brm(fm_gaze, data = t_gaze_p1, 
                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                    seed = 2021,
                    save_pars = save_pars(all = TRUE)
                    )
```

```{r, warning = F}
m_cau_2l_p2 <- brm(fm, data = t_cau_p2, 
                   warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                   seed = 2022,
                   save_pars = save_pars(all = TRUE)
                   )
m_inf_2l_p2 <- brm(fm, data = t_inf_p2, 
                   warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                   seed = 2022,
                   save_pars = save_pars(all = TRUE)
                   )
m_quant_2l_p2 <- brm(fm, data = t_quant_p2, 
                     warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                     seed = 2022,
                     save_pars = save_pars(all = TRUE)
                     )
m_gaze_2l_p2 <- brm(fm_gaze, data = t_gaze_p2, 
                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                    seed = 2022,
                    save_pars = save_pars(all = TRUE)
                    )
m_grat_2l_p2 <- brm(fm, data = t_grat_p2,
                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                    seed = 2022,
                    save_pars = save_pars(all = TRUE)
                    )
```

```{r, eval = F}
summary(m_cau_2l_p1)
summary(m_inf_2l_p1)
summary(m_quant_2l_p1)
summary(m_gaze_2l_p1)

summary(m_cau_2l_p2)
summary(m_inf_2l_p2)
summary(m_quant_2l_p2)
summary(m_gaze_2l_p2)
summary(m_grat_2l_p2)

library(loo)
lapply(list(m_cau_2l_p1, m_inf_2l_p1, m_quant_2l_p1, m_gaze_2l_p1), loo)
lapply(list(m_cau_2l_p2, m_inf_2l_p2, m_quant_2l_p2, m_gaze_2l_p2, m_grat_2l_p2), loo)
```

## Predictive Projection

```{r}
# delay random intercept to last place so that it doesn't soak up all the variance
s_terms <- c("1", all_fixed_effects, 
             paste0(paste(all_fixed_effects, collapse = " + "), " + (1 | subject)")) 
tmp <- all_fixed_effects[-2]
s_terms_gaze <- c("1", c(tmp, "day2"), 
                  paste0(paste(c(tmp, "day2"), collapse = " + "), " + (1 | subject)"))
```

```{r}
# define reference models
refM_cau_p1 <- get_refmodel(m_cau_2l_p1)
refM_inf_p1 <- get_refmodel(m_inf_2l_p1)
refM_quant_p1 <- get_refmodel(m_quant_2l_p1)
refM_gaze_p1 <- get_refmodel(m_gaze_2l_p1)

refM_cau_p2 <- get_refmodel(m_cau_2l_p2)
refM_inf_p2 <- get_refmodel(m_inf_2l_p2)
refM_quant_p2 <- get_refmodel(m_quant_2l_p2)
refM_gaze_p2 <- get_refmodel(m_gaze_2l_p2)
refM_grat_p2 <- get_refmodel(m_grat_2l_p2)
```

```{r, warning = F}
cvs_cau <- cv_varsel(refM_cau_p1, 
                     search_terms = s_terms, cv_method = "LOO", method = "forward", 
                     seed = 2021)
summary(cvs_cau); plot(cvs_cau, stats = c('elpd', 'rmse'))
# proj_cau_cv <- project(cvs_cau, solution_terms = c(1, 2, 3, 14))
# mcmc_areas(as.matrix(proj_cau_cv), pars = solution_terms(cvs_cau)[c(1, 2, 3, 14)])
```
**relevant** covariates: (1 | subject), group

```{r, warning = F}
cvs_inf <- cv_varsel(refM_inf_p1, 
                     search_terms = s_terms, cv_method = "LOO", method = "forward", 
                     seed = 2021)
summary(cvs_inf); plot(cvs_inf, stats = c('elpd', 'rmse'))
# proj_inf_cv <- project(cvs_inf, solution_terms = c(1, 2, 14))
# mcmc_areas(as.matrix(proj_inf_cv), pars = solution_terms(cvs_inf)[c(1, 2, 14)])
```
**relevant** covariates: (1 | subject), time_in_leipzig, group, age

```{r, warning = F}
cvs_quant <- cv_varsel(refM_quant_p1, 
                       search_terms = s_terms, cv_method = "LOO", method = "forward", 
                       seed = 2021)
summary(cvs_quant); plot(cvs_quant, stats = c('elpd', 'rmse'))
# proj_quant_cv <- project(cvs_quant, solution_terms = c(1, 2, 3, 15))
# mcmc_areas(as.matrix(proj_quant_cv), pars = solution_terms(cvs_quant)[c(1, 2, 3, 15)])
```
**relevant** covariates: (1 | subject), rel_rank, rearing, time_in_leipzig, group, time_outdoors

```{r, warning = F}
cvs_gaze <- cv_varsel(refM_gaze_p1, 
                      search_terms = s_terms_gaze, cv_method = "LOO", method = "forward", 
                      seed = 2021)
summary(cvs_gaze); plot(cvs_gaze, stats = c('elpd', 'rmse'))
# proj_gaze_cv <- project(cvs_gaze, solution_terms = c(1, 2, 3, 4, 5, 6, 7, 15))
# mcmc_areas(as.matrix(proj_gaze_cv), pars = solution_terms(cvs_gaze)[c(1, 2, 3, 4, 5, 6, 7, 15)])
```
**relevant** covariates: group, sex (random intercept removed due to convergence issues)




```{r}
fm_gaze <- update(fm, . ~ . +day2 -test_day -(1|subject))
m_gaze_2l <- brm(fm_gaze, data = t_gaze, 
                 warmup = 1e3, iter = 4e3, cores = ncores, chains = 4, 
                 seed = 2021,
                 save_pars = save_pars(all = TRUE)
                 )
s_terms_gaze <- c("1", c(tmp, "day2"), 
                  paste0(paste(c(tmp, "day2"), collapse = " + "))) 
refM_gaze <- get_refmodel(m_gaze_2l)
```

```{r, warning = F}
cvs_gaze <- cv_varsel(refM_gaze, 
                      search_terms = s_terms_gaze, cv_method = "LOO", method = "forward", 
                      seed = 2020)
summary(cvs_gaze); plot(cvs_gaze, stats = c('elpd', 'rmse'))
# proj_gaze_cv <- project(cvs_gaze, solution_terms = c(1, 2, 3, 4, 5, 6, 7, 15))
# mcmc_areas(as.matrix(proj_gaze_cv), pars = solution_terms(cvs_gaze)[c(1, 2, 3, 4, 5, 6, 7, 15)])
```
**relevant** covariates: group, sex (random intercept removed due to convergence issues)





```{r, warning = F}
cvs_grat <- cv_varsel(refM_grat, 
                      search_terms = s_terms, cv_method = "LOO", method = "forward", 
                      seed = 2020)
summary(cvs_grat); plot(cvs_grat, stats = c('elpd', 'rmse'))
# proj_gaze_cv <- project(cvs_gaze, solution_terms = c(1, 2, 3, 4, 5, 6, 7, 15))
# mcmc_areas(as.matrix(proj_gaze_cv), pars = solution_terms(cvs_gaze)[c(1, 2, 3, 4, 5, 6, 7, 15)])
```
**relevant** covariates: (1 | subject), rel_rank, observer_mod, sex, group










